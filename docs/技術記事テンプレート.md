# FitGraph 技術記事：機能別実装ロジック解説

## 目次
1. [概要](#概要)
2. [全体アーキテクチャ](#全体アーキテクチャ)
3. [ユーザー認証機能](#1-ユーザー認証機能)
4. [プロフィール管理機能](#2-プロフィール管理機能)
5. [身体記録機能](#3-身体記録機能)
6. [進捗可視化機能](#4-進捗可視化機能)
7. [YouTube動画連携機能](#5-youtube動画連携機能)
8. [お気に入り動画管理機能](#6-お気に入り動画管理機能)
9. [LINE Bot リマインド機能](#7-line-bot-リマインド機能)
10. [まとめ](#まとめ)

---

## 概要

### アプリケーション概要
<!-- FitGraphの目的、ターゲットユーザー、解決する課題を記載 -->

### 使用技術スタック
- **バックエンド**: Ruby on Rails 7.2.1, Ruby 3.3.6
- **フロントエンド**: Hotwire (Turbo/Stimulus), JavaScript, Chart.js, DaisyUI
- **CSSフレームワーク**: Tailwind CSS
- **Web API**: Google API (OAuth 2.0, YouTube Data API), LINE Messaging API
- **ストレージ**: Active Storage
- **データベース**: PostgreSQL
- **インフラ**: Render, Docker

---

## 全体アーキテクチャ

### システム構成図
<!-- 全体のシステム構成図を記載 -->

### アプリケーション構造
<!-- MVCアーキテクチャ + Service層の説明 -->

#### ディレクトリ構成
```
app/
├── controllers/    # リクエスト処理
├── models/         # データモデル
├── services/       # ビジネスロジック
├── views/          # 表示層（Hotwire）
└── javascript/     # フロントエンド処理（Stimulus）
```

### 設計思想
<!-- Service層を導入した理由、責務の分離など -->

---

## 1. ユーザー認証機能

### 機能概要
<!-- OAuth 2.0を使用したGoogle認証、LINE認証の説明 -->

### 技術選定理由
<!-- なぜOAuth 2.0を選んだのか、Deviseやその他の選択肢との比較 -->

### データモデル
```ruby
# app/models/user.rb の主要な属性と関連
- uid (OAuth プロバイダーのユーザーID)
- provider (google_oauth2 / line)
- email
- name
- リレーション: has_one :profile, has_many :body_records, etc.
```

### 実装のポイント

#### OAuthフロー
```
1. ユーザーがログインボタンをクリック
2. プロバイダー（Google/LINE）の認証画面へリダイレクト
3. 認証成功後、コールバックURLへリダイレクト
4. コールバックで受け取った情報からユーザーを作成/取得
5. セッション確立
```

#### コードスニペット
```ruby
# app/models/user.rb
# OAuthコールバック処理のロジック

def self.from_omniauth(auth)
  # 実装内容を記載
end
```

### 工夫した点
<!-- セキュリティ面での工夫、エラーハンドリング、UX向上のための工夫など -->

### 課題と解決策
<!-- 実装中に直面した課題とその解決方法 -->

---

## 2. プロフィール管理機能

### 機能概要
<!-- 身長、性別、トレーニング強度、目標体重などの基本情報管理 -->

### データモデル
```ruby
# app/models/profile.rb の主要な属性
- user_id (外部キー)
- height (身長)
- biological_sex (生物学的性別)
- training_intensity (トレーニング強度)
- target_weight (目標体重)
```

### 実装のポイント

#### バリデーション
```ruby
# app/models/profile.rb
# バリデーションルール
```

#### コントローラー処理
```ruby
# app/controllers/profiles_controller.rb
# プロフィールの作成・更新処理
```

### 工夫した点
<!-- フォームのUX、バリデーションの工夫など -->

### 課題と解決策

---

## 3. 身体記録機能

### 機能概要
<!-- 体重、体脂肪率、身体の写真を記録する機能 -->

### データモデル
```ruby
# app/models/body_record.rb の主要な属性
- user_id (外部キー)
- recorded_at (記録日時)
- weight (体重)
- body_fat (体脂肪率)
- fat_mass (脂肪量)
- photo (Active Storage - 身体の写真)
```

### 実装のポイント

#### Service層の活用
```ruby
# app/services/body_record_photo_service.rb
# 写真のアップロード・処理ロジック
```

#### Active Storageの活用
```ruby
# 画像のアップロード、リサイズ、バリデーション
```

#### Webカメラ連携
```javascript
// app/javascript/controllers/camera_controller.js
// Stimulus Controller でWebカメラを起動
```

### 工夫した点
<!--
- 各項目を任意入力にした設計
- 写真撮影のUX
- データの永続化とバリデーション
-->

### 課題と解決策
<!-- 画像サイズの最適化、エラーハンドリングなど -->

---

## 4. 進捗可視化機能

### 機能概要
<!-- グラフによる体重推移の可視化、写真による身体の変化の確認 -->

### 技術選定理由
<!-- Chart.jsを選んだ理由 -->

### 実装のポイント

#### グラフ描画（Chart.js）
```ruby
# app/services/progress_data_service.rb
# グラフ用データの整形ロジック
```

```javascript
// app/javascript/controllers/chart_controller.js
// Chart.js を使ったグラフ描画
```

#### 写真のレイヤー表示
```javascript
// app/javascript/controllers/photo_slider_controller.js
// スライダーで写真を切り替える処理
```

### 工夫した点
<!--
- データの集計・整形ロジック
- レスポンシブ対応
- スライダーのUX
-->

### 課題と解決策
<!-- パフォーマンス最適化、データ量が多い場合の対処など -->

---

## 5. YouTube動画連携機能

### 機能概要
<!-- YouTube Data APIを使ったおすすめ動画の提案 -->

### 技術選定理由
<!-- YouTube Data APIを使う理由、検索条件の設定方法 -->

### データモデル
```ruby
# app/models/recommended_video.rb の主要な属性
- user_id (外部キー)
- video_id (YouTube動画ID)
- title
- thumbnail_url
- published_at
```

### 実装のポイント

#### YouTube API連携
```ruby
# app/services/youtube_api_service.rb
# API呼び出しとレスポンス処理
```

```ruby
# app/services/recommended_video_service.rb
# ユーザーのプロフィールに基づく動画推薦ロジック
```

#### 動画の埋め込み再生
```erb
<!-- app/views/recommended_videos/show.html.erb -->
<!-- YouTube Player API を使った埋め込み再生 -->
```

### 工夫した点
<!--
- プロフィール情報を元にした検索キーワードの生成
- API制限への対処（キャッシュ、レート制限）
- 動画の再生体験
-->

### 課題と解決策
<!-- APIクォータ制限、検索精度の向上など -->

---

## 6. お気に入り動画管理機能

### 機能概要
<!-- ユーザーが任意の動画URLを登録・管理できる機能 -->

### データモデル
```ruby
# app/models/favorite_video.rb の主要な属性
- user_id (外部キー)
- video_url
- title
- memo (メモ)
```

### 実装のポイント

#### URL解析とバリデーション
```ruby
# app/services/favorite_video_service.rb
# YouTube URLの解析、video_idの抽出
```

#### CRUD処理
```ruby
# app/controllers/favorite_videos_controller.rb
# お気に入り動画の作成・更新・削除
```

### 工夫した点
<!-- URL形式のバリデーション、エラーハンドリング -->

### 課題と解決策

---

## 7. LINE Bot リマインド機能

### 機能概要
<!-- LINE Messaging APIを使ったリマインド通知 -->

### 技術選定理由
<!-- なぜLINEを選んだのか -->

### 実装のポイント

#### LINE Bot連携
```ruby
# app/services/line_bot_service.rb
# メッセージ送信、Webhook処理
```

#### Webhook処理
```ruby
# app/controllers/line_bot_controller.rb
# LINEからのイベント受信・処理
```

#### スケジュール通知
```ruby
# 定期的なリマインド送信のロジック
# （cronジョブ、Sidekiq、その他スケジューラーを使用）
```

### 工夫した点
<!--
- ユーザーの設定時間に合わせた通知
- Webhook署名検証
- エラーハンドリング
-->

### 課題と解決策
<!-- タイムゾーン対応、通知の信頼性確保など -->

---

## まとめ

### 実装を通じて学んだこと
<!-- 技術的な学び、設計の学びなど -->

### 今後の改善点
<!-- パフォーマンス改善、機能追加、リファクタリングなど -->

### 参考資料
<!-- 使用したドキュメント、参考にした記事など -->
- [Ruby on Rails ガイド](https://railsguides.jp/)
- [Google OAuth 2.0 ドキュメント](https://developers.google.com/identity/protocols/oauth2)
- [YouTube Data API](https://developers.google.com/youtube/v3)
- [LINE Messaging API](https://developers.line.biz/ja/docs/messaging-api/)
- [Hotwire公式ドキュメント](https://hotwired.dev/)
- [Chart.js公式ドキュメント](https://www.chartjs.org/)
