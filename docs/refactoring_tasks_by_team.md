# FitGraph リファクタリング - チーム別タスク一覧

## チーム1: 認証機能

### 担当領域
- User モデル
- 認証関連コントローラー (SessionsController, OmniauthCallbacksController等)
- 二要素認証

### タスク

#### User モデル責務分離
- [ ] OmniauthAuthenticationService 抽出
  - User.from_omniauth を Service に移動
  - OAuth プロバイダごとのロジック整理
  - テスト追加
  - **完了条件**: User モデルが30行以下、認証テストが全て通過

- [ ] TwoFactorAuthService 抽出
  - 二要素認証ロジックを Service に移動
  - QR コード生成ロジックの整理
  - テスト追加
  - **完了条件**: サービスのテストカバレッジ90%以上

#### 認証 Controller リファクタリング
- [ ] AuthenticationConcern 作成
  - 共通処理を Concern に抽出
  - エラーハンドリングの統一
  - **完了条件**: Controller間で重複コードゼロ

- [ ] セキュリティ強化
  - ログ出力から機密情報除去
  - セッション管理の見直し
  - CSRF 保護の確認
  - **完了条件**: 機密情報がログに出力されない、セキュリティテスト通過

---

## チーム2: BodyRecords 機能

### 担当領域
- BodyRecord モデル
- BodyRecordsController
- 体重・体脂肪率記録機能

### タスク

#### Service 層構築
- [ ] DateParsingService 作成
  - 日付パースロジックを共通化
  - エラーハンドリング統一
  - テスト追加
  - **完了条件**: 日付処理が一元化、エラーハンドリング統一

- [ ] BodyRecordForm Object 作成
  - バリデーションロジックを Form に集約
  - Controller からロジックを削除
  - テスト追加
  - **完了条件**: Controller が60行以下

- [ ] BodyRecordFinder 作成
  - レコード検索ロジックを Service に抽出
  - 日付範囲検索の共通化
  - テスト追加
  - **完了条件**: Service のテストカバレッジ90%以上

#### モデルテスト追加
- [ ] BodyRecord モデルのテスト追加
  - バリデーションテスト
  - アソシエーションテスト
  - スコープテスト
  - **完了条件**: モデルのテストカバレッジ90%以上

---

## チーム3: Progress 機能

### 担当領域
- ProgressController
- progress/index.html.erb (最大の難関ファイル)
- グラフ表示機能

### タスク

#### View テンプレート分割
- [ ] JavaScript 外部ファイル化
  - progress/index.html.erb から JS を抽出
  - app/javascript/progress_chart.js に移動
  - app/javascript/progress_stats.js に移動
  - **完了条件**: index.html.erb が100行以下

- [ ] View パーシャル化
  - グラフ表示部分を _graph_view.html.erb に分割
  - 写真表示部分を _photo_view.html.erb に分割
  - 統計表示部分を _stats_table.html.erb に分割
  - **完了条件**: 機能が全て動作する、表示崩れなし

- [ ] CSS 外部化
  - インラインスタイルを削除
  - app/assets/stylesheets/progress.css に移動
  - **完了条件**: インラインスタイルゼロ

#### JavaScript モジュール化
- [ ] ChartConfig クラス作成
  - グラフオプションの設定ファイル化
  - カスタムプラグインの独立モジュール化
  - **完了条件**: グローバル変数ゼロ

- [ ] ProgressGraph モジュール作成
  - グラフ描画ロジックをクラス化
  - データ変換ロジックの分離
  - 期間切り替えロジックの整理
  - **完了条件**: 単一責任原則に準拠

- [ ] ProgressStats モジュール作成
  - 統計計算ロジックをクラス化
  - DOM 操作の最適化
  - **完了条件**: レスポンシブ動作保証

---

## チーム4: YouTube 機能

### 担当領域
- YoutubeService
- TrainingVideosController
- YouTube API 連携

### タスク

#### YouTube Service 改善
- [ ] 設定外部化
  - KEYWORDS を config/youtube_keywords.yml に移動
  - 環境別設定対応
  - **完了条件**: 設定がYAMLで管理

- [ ] エラーハンドリング強化
  - API エラー時のリトライ実装
  - フォールバック動画の設定
  - タイムアウト処理追加
  - **完了条件**: APIエラーで落ちない

#### キャッシング実装
- [ ] Redis 導入
  - Redis の環境構築
  - 接続設定
  - **完了条件**: Redis が正常に動作

- [ ] API レスポンスキャッシング
  - 動画検索結果のキャッシュ
  - キャッシュ有効期限の設定
  - **完了条件**: API呼び出し回数80%削減

- [ ] 推薦動画のキャッシュ戦略
  - ユーザーごとのキャッシュ管理
  - キャッシュクリア機能
  - **完了条件**: レスポンス時間50%短縮

---

## チーム5: LINE Bot 機能

### 担当領域
- LineBotService
- LINE 通知機能
- LINE 連携

### タスク

#### LINE Bot 機能整理
- [ ] LineBotService のメソッド分割
  - send_notification メソッドの責務を明確化
  - 通知タイプ別のメソッドに分割
  - **完了条件**: 単一責任原則に準拠

- [ ] 時刻パースロジックの共通化
  - 時刻変換処理を DateParsingService に統合
  - エラーハンドリング統一
  - **完了条件**: 時刻処理が一元化

- [ ] テスト追加
  - LINE API のモック化
  - 通知送信テスト
  - エラーケーステスト
  - **完了条件**: テストカバレッジ80%以上

---

## チーム6: Profile 機能

### 担当領域
- Profile モデル
- ProfilesController
- ユーザープロフィール管理

### タスク

#### Profile 機能整理
- [ ] ProfilesController の更新処理分離
  - LINE友達追加処理を別アクションに分離
  - 通常更新とLINE連携更新を明確に区別
  - **完了条件**: LINE友達追加と通常更新が別アクションに

- [ ] Profile モデルのバリデーション追加
  - notification_time のフォーマット検証
  - 通知設定の整合性チェック
  - **完了条件**: バリデーションが適切に機能

- [ ] テスト追加
  - Profile モデルのバリデーションテスト
  - Controller のアクションテスト
  - **完了条件**: テストカバレッジ80%以上

---

## チーム7: JavaScript / Stimulus

### 担当領域
- Stimulus Controllers
- JavaScript の整理・最適化
- フロントエンドの改善

### タスク

#### Stimulus Controller 改善
- [ ] progress_controller.js の空実装メソッド削除
  - 未実装メソッドの特定と削除
  - 必要なメソッドの実装
  - **完了条件**: 未実装メソッドゼロ

- [ ] photo_switcher_controller.js の最適化
  - 写真切り替えロジックの改善
  - パフォーマンス最適化
  - **完了条件**: 動作がスムーズ

- [ ] イベントハンドリング統一
  - イベントリスナーの命名規則統一
  - 不要な console.log の削除
  - **完了条件**: console.log ゼロ

#### Stimulus Controller 統合
- [ ] progress_controller.js と外部モジュールの連携
  - ProgressGraph モジュールとの統合
  - データフロー整理
  - **完了条件**: Controller が Facade として機能

- [ ] テストの追加
  - JavaScript テストフレームワーク導入
  - 主要機能のテスト追加
  - **完了条件**: JavaScript テストカバレッジ60%以上

---

## チーム8: View / Component

### 担当領域
- View テンプレート全般
- ViewComponent の導入
- アクセシビリティ向上

### タスク

#### ViewComponent 導入
- [ ] HeaderComponent 作成
  - 共通ヘッダーを Component 化
  - パラメータの受け渡し設計
  - **完了条件**: 全ページで Header Component を使用

- [ ] FooterComponent 作成
  - 共通フッターを Component 化
  - **完了条件**: 全ページで Footer Component を使用

- [ ] FlashComponent 作成
  - フラッシュメッセージを Component 化
  - スタイルの統一
  - **完了条件**: ViewComponent のテスト追加

#### View 全体最適化
- [ ] フォームパーシャルの共通化
  - 重複するフォーム要素を部分テンプレート化
  - form_with の統一
  - **完了条件**: View の重複コード50%削減

- [ ] ARIA 属性追加
  - アクセシビリティ向上のための属性追加
  - スクリーンリーダー対応
  - **完了条件**: アクセシビリティスコア向上

- [ ] セマンティック HTML 適用
  - div 中心の構造から意味のあるタグへ変更
  - header, nav, main, footer 等の使用
  - **完了条件**: HTML 構造が意味的に正しい

- [ ] Helper メソッド整理
  - ApplicationHelper の肥大化解消
  - 機能別 Helper への分割
  - **完了条件**: Helper が適切に分割されている

---

## チーム9: テスト基盤 / QA

### 担当領域
- テスト環境整備
- テストカバレッジ向上
- 品質保証

### タスク

#### テスト基盤整備
- [ ] SimpleCov 導入
  - カバレッジ測定ツールの導入
  - レポート出力設定
  - **完了条件**: カバレッジレポートが取得できる

- [ ] 現在のテストカバレッジ測定
  - 全テストの実行と計測
  - ベースライン確立
  - **完了条件**: 全テストが通過している、テスト実行時間を記録

- [ ] RSpec 設定の標準化
  - spec_helper.rb の整理
  - rails_helper.rb の整理
  - **完了条件**: テスト設定が統一されている

- [ ] Factory Bot のベストプラクティス整理
  - Factory の命名規則統一
  - 重複 Factory の削除
  - **完了条件**: Factory が整理されている

- [ ] CI/CD パイプライン確認
  - GitHub Actions の動作確認
  - テスト自動実行の確認
  - **完了条件**: CI/CD が正常に動作

#### テストカバレッジ向上
- [ ] モデルテスト追加
  - User モデルのテスト強化
  - BodyRecord モデルのテスト追加
  - Profile モデルのバリデーションテスト
  - **完了条件**: カバレッジ60%以上

- [ ] システムテスト追加
  - ログイン〜ログアウトの E2E テスト
  - 体重記録の登録フローテスト
  - **完了条件**: 主要ユーザーフローがテストでカバー

#### 品質保証
- [ ] E2E テスト完成
  - 全主要フローのテスト追加
  - エラーケースのテスト
  - **完了条件**: 全主要フローがカバーされている

- [ ] カバレッジ最終確認
  - 目標 80% 達成確認
  - カバレッジレポート作成
  - **完了条件**: カバレッジ80%以上、全テスト通過

- [ ] パフォーマンステスト
  - 負荷テスト実施
  - レスポンスタイム計測
  - ボトルネック特定・改善
  - **完了条件**: パフォーマンス基準クリア

---

## チーム10: インフラ / DB最適化

### 担当領域
- データベース最適化
- インフラ設定
- セキュリティ監査
- デプロイ準備

### タスク

#### インフラ・設定監査
- [ ] Gem の脆弱性チェック
  - bundle audit の実行
  - 脆弱性のある Gem の更新
  - **完了条件**: セキュリティアラートゼロ

- [ ] 未使用 Gem の特定
  - Gemfile の整理
  - 不要な Gem の削除
  - **完了条件**: 未使用 Gem ゼロ

- [ ] データベースインデックス監査
  - 現状のインデックス確認
  - 不足しているインデックスの特定
  - **完了条件**: インデックス改善案リスト作成

- [ ] N+1 クエリの検出
  - Bullet Gem 導入
  - N+1 クエリの特定
  - **完了条件**: パフォーマンスボトルネック一覧作成

- [ ] 環境変数の棚卸し
  - .env.example の更新
  - 未使用環境変数の削除
  - **完了条件**: 環境変数ドキュメント整備

#### DB最適化
- [ ] インデックス追加
  - body_records.user_id にインデックス
  - body_records.recorded_at にインデックス
  - favorite_videos.user_id にインデックス
  - **完了条件**: マイグレーション作成・実行完了

- [ ] N+1 クエリ解消
  - Bullet の警告をゼロにする
  - includes/joins の追加
  - **完了条件**: Bullet警告ゼロ、クエリ実行時間50%削減

#### デプロイ準備
- [ ] 本番環境設定確認
  - 環境変数の確認
  - データベース設定確認
  - **完了条件**: 本番設定が正しい

- [ ] マイグレーション確認
  - マイグレーションファイルのレビュー
  - ロールバック可能性確認
  - **完了条件**: マイグレーション戦略確定

- [ ] ロールバック手順書作成
  - 各機能のロールバック手順書作成
  - 緊急時の対応フロー整理
  - **完了条件**: デプロイ手順書完成、ロールバック手順確認済み

- [ ] モニタリング設定
  - エラー監視設定 (Sentry等)
  - パフォーマンス監視設定
  - **完了条件**: モニタリングが稼働

---

## 全チーム共通タスク

### 準備段階
- [ ] 開発環境セットアップ
- [ ] ブランチ戦略の決定 (Git Flow推奨)
- [ ] コーディング規約の確認
- [ ] レビュープロセスの確立

### 最終段階
- [ ] 最終統合テスト
- [ ] パフォーマンステスト
- [ ] セキュリティ監査
- [ ] ドキュメント整備
- [ ] リリースノート作成

---

## Definition of Done (完了の定義)

全タスクは以下の条件を満たして初めて「完了」とする:

### コード品質
- [ ] RuboCop 警告ゼロ
- [ ] ESLint 警告ゼロ (JavaScript)
- [ ] コードレビュー承認済み
- [ ] 既存テスト全て通過
- [ ] 新規テスト追加済み

### 機能動作
- [ ] 機能が正常に動作する
- [ ] リグレッションテストクリア
- [ ] ブラウザ互換性確認 (Chrome, Firefox, Safari)
- [ ] レスポンシブ表示確認 (PC, タブレット, スマホ)

### ドキュメント
- [ ] コメント追加 (必要に応じて)
- [ ] README 更新 (必要に応じて)
- [ ] CHANGELOG 更新

### デプロイ
- [ ] main ブランチにマージ済み
- [ ] ステージング環境で動作確認済み

---

## チーム間の依存関係

### チーム9 (テスト基盤) → 全チーム
- テスト基盤整備が完了してから各チームの本格作業開始

### チーム10 (インフラ) → 全チーム
- DB最適化、N+1解消が完了してからパフォーマンスチューニング可能

### チーム2 (BodyRecords) → チーム3 (Progress)
- DateParsingService が完成してから Progress 機能で利用可能

### チーム3 (Progress View分割) → チーム7 (JavaScript)
- View から JavaScript が分離されてから JavaScript モジュール化可能

### チーム8 (ViewComponent) → 全チーム
- 共通コンポーネントが完成してから各画面で利用可能
